{"version":3,"sources":["../src/FormBinder.js"],"names":["FormBinder","originalObj","bindingDefs","onAnyModified","_id","_onAnyModified","_bindings","_originalObj","path","bindingDef","binding","isDisabled","_ensureFunc","isReadOnly","isVisible","noValue","state","alwaysGet","isValid","value","_getObjectPathValue","initValue","pre","unmodifiedValue","post","v","modified","_updateBindingStates","obj","def","validator","constructor","Function","r","m","newValue","lastAnyModified","anyModified","Error","allValid","valid","metadata","Object","assign","disabled","readOnly","visible","anyChanges","emit","getBindingState","trim","_setObjectPathValue","split","forEach","namePart","i","nameParts","length"],"mappings":"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","file":"FormBinder.js","sourcesContent":["import EventEmitter from \"eventemitter3\"\n\nexport class FormBinder extends EventEmitter {\n  constructor(originalObj, bindingDefs, onAnyModified) {\n    super()\n    this._id = originalObj._id\n    this._onAnyModified = onAnyModified\n    this._bindings = {}\n    this._originalObj = originalObj\n\n    for (let path in bindingDefs) {\n      let bindingDef = bindingDefs[path]\n      let binding = {\n        isDisabled: this._ensureFunc(bindingDef.isDisabled, false),\n        isReadOnly: this._ensureFunc(bindingDef.isReadOnly, false),\n        isVisible: this._ensureFunc(bindingDef.isVisible, true),\n        noValue: !!bindingDef.noValue,\n      }\n\n      if (binding.noValue) {\n        binding.state = {}\n      } else {\n        binding.alwaysGet = bindingDef.alwaysGet\n        binding.isValid = this._ensureFunc(bindingDef.isValid, true, true)\n\n        let value = FormBinder._getObjectPathValue(originalObj, path)\n\n        if (typeof value === \"undefined\") {\n          value =\n            typeof bindingDef.initValue !== \"undefined\"\n              ? bindingDef.initValue\n              : \"\"\n        }\n\n        value = bindingDef.pre ? bindingDef.pre(value) : value\n\n        binding.unmodifiedValue = value\n        binding.post = bindingDef.post || ((v) => v)\n        binding.state = {\n          value,\n          modified: false,\n        }\n      }\n\n      this._bindings[path] = binding\n    }\n\n    this._updateBindingStates()\n  }\n\n  get id() {\n    return this._id\n  }\n\n  get originalObj() {\n    return this._originalObj\n  }\n\n  _ensureFunc(obj, def, validator) {\n    // If obj is a func and does not return bool there are problems, so we wrap it.\n    if (obj) {\n      if (obj.constructor === Function) {\n        if (validator) {\n          return (r, v, m) => !!obj(r, v, m)\n        } else {\n          return (r) => !!obj(r)\n        }\n      } else {\n        return () => !!obj\n      }\n    } else {\n      return () => def\n    }\n  }\n\n  updateBindingValue(path, newValue) {\n    let lastAnyModified = this.anyModified\n    let binding = this._bindings[path]\n\n    if (binding) {\n      if (binding.noValue) {\n        throw new Error(\n          `Attempt to update value for non-value binding '${path}'`\n        )\n      }\n\n      binding.state.value = newValue\n      binding.state.modified = newValue !== binding.unmodifiedValue\n\n      this._updateBindingStates(binding)\n\n      if (lastAnyModified !== this.anyModified && this._onAnyModified) {\n        this._onAnyModified(this.anyModified)\n      }\n    }\n\n    return binding.state\n  }\n\n  _updateBindingStates() {\n    this.anyModified = false\n    this.allValid = true\n\n    for (let path in this._bindings) {\n      let binding = this._bindings[path]\n\n      // Do non-value bindings after value bindings and ignore any just changed binding\n      if (binding.noValue) {\n        continue\n      }\n\n      let valid = binding.isValid(this, binding.state.value, binding.metadata)\n\n      // Only value bindings can change these two properties\n      this.allValid = valid && this.allValid\n      this.anyModified = binding.state.modified || this.anyModified\n\n      Object.assign(binding.state, {\n        valid,\n        disabled: binding.isDisabled(this),\n        readOnly: binding.isReadOnly(this),\n        visible: binding.isVisible(this),\n      })\n    }\n\n    for (let path in this._bindings) {\n      let binding = this._bindings[path]\n\n      if (!binding.noValue) {\n        continue\n      }\n\n      let disabled = binding.isDisabled(this)\n      let readOnly = binding.isReadOnly(this)\n      let visible = binding.isVisible(this)\n\n      // Did the valid, disabled, read-only or visible state of this binding change?\n      let anyChanges =\n        disabled !== binding.state.disabled ||\n        readOnly !== binding.state.readOnly ||\n        visible !== binding.state.visible\n\n      if (anyChanges) {\n        binding.state = {\n          disabled,\n          readOnly,\n          visible,\n        }\n\n        // Fire an event so the component can update itself\n        this.emit(path, { path, state: binding.state })\n      }\n    }\n  }\n\n  getBindingValue(path) {\n    return this.getBindingState(path).value\n  }\n\n  getBindingState(path) {\n    let binding = this._bindings[path]\n\n    if (!binding) {\n      throw new Error(`There is no binding entry for '${path}'`)\n    }\n\n    return binding.state\n  }\n\n  getModifiedBindingValues() {\n    // Generate an object that has the modified and alwaysGet bindings\n    let obj = {}\n\n    if (!this.anyModified && !this.allValid) {\n      return obj\n    }\n\n    // Will have an _id if updating\n    if (this._id) {\n      obj._id = this._id\n    }\n\n    for (let path in this._bindings) {\n      let binding = this._bindings[path]\n\n      if (binding.alwaysGet || (!binding.noValue && binding.state.modified)) {\n        let value = binding.state.value\n\n        if (value && value.constructor === \"String\") {\n          value = value.trim()\n\n          if (value === binding.unmodifiedValue) {\n            continue\n          }\n        }\n\n        value = binding.post ? binding.post(value) : value\n\n        FormBinder._setObjectPathValue(obj, path, value)\n      }\n    }\n\n    return obj\n  }\n\n  static _getObjectPathValue(obj, path) {\n    path.split(\".\").forEach((namePart) => {\n      if (obj) {\n        obj = obj[namePart]\n      }\n    })\n    return obj\n  }\n\n  static _setObjectPathValue(obj, path, value) {\n    path.split(\".\").forEach((namePart, i, nameParts) => {\n      if (i < nameParts.length - 1) {\n        if (!obj[namePart]) {\n          obj[namePart] = {}\n        }\n        obj = obj[namePart]\n      } else {\n        obj[namePart] = value\n      }\n    })\n  }\n}\n"]}