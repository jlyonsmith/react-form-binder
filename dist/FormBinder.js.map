{"version":3,"sources":["../src/FormBinder.js"],"names":["FormBinder","originalObj","bindingDefs","options","_id","_onAnyModified","onAnyModified","_readOnly","readOnly","_metadata","metadata","_bindings","_originalObj","path","bindingDef","binding","isDisabled","_ensureFunc","isReadOnly","isVisible","noValue","state","alwaysGet","isValid","value","_getObjectPathValue","pre","unmodifiedValue","post","v","modified","_updateBindingAttributes","JSON","parse","stringify","obj","def","validator","constructor","Function","r","m","newValue","lastAnyModified","anyModified","Error","allValid","valid","Object","assign","disabled","visible","anyChanges","emit","getBindingState","trim","_setObjectPathValue","split","forEach","namePart","i","nameParts","length","EventEmitter"],"mappings":"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","sourcesContent":["import EventEmitter from \"eventemitter3\"\n\nexport class FormBinder extends EventEmitter {\n  constructor(originalObj, bindingDefs, options) {\n    super()\n    this._id = originalObj._id\n\n    if (options) {\n      if (typeof options === \"function\") {\n        this._onAnyModified = options\n      } else {\n        this._onAnyModified = options.onAnyModified\n        this._readOnly = options.readOnly\n        this._metadata = options.metadata\n      }\n    }\n\n    this._bindings = {}\n    this._originalObj = originalObj\n\n    for (let path in bindingDefs) {\n      let bindingDef = bindingDefs[path]\n      let binding = {\n        isDisabled: this._ensureFunc(bindingDef.isDisabled, false),\n        isReadOnly: this._ensureFunc(bindingDef.isReadOnly, false),\n        isVisible: this._ensureFunc(bindingDef.isVisible, true),\n        noValue: !!bindingDef.noValue,\n      }\n\n      if (binding.noValue) {\n        binding.state = {}\n      } else {\n        binding.alwaysGet = bindingDef.alwaysGet\n        binding.isValid = this._ensureFunc(bindingDef.isValid, true, true)\n\n        let value = FormBinder._getObjectPathValue(originalObj, path)\n\n        value = bindingDef.pre ? bindingDef.pre(value) : value\n        value = typeof value === \"undefined\" ? \"\" : value\n        binding.unmodifiedValue = value\n        binding.post = bindingDef.post || ((v) => v)\n        binding.state = {\n          value,\n          modified: false,\n        }\n      }\n\n      this._bindings[path] = binding\n    }\n\n    this._updateBindingAttributes()\n  }\n\n  get id() {\n    return this._id\n  }\n\n  get readOnly() {\n    return this._readOnly\n  }\n\n  getMetadata() {\n    return JSON.parse(JSON.stringify(this._metadata))\n  }\n\n  getOriginalObject() {\n    return JSON.parse(JSON.stringify(this._originalObj))\n  }\n\n  _ensureFunc(obj, def, validator) {\n    // If obj is a func and does not return bool there are problems, so we wrap it.\n    if (obj) {\n      if (obj.constructor === Function) {\n        if (validator) {\n          return (r, v, m) => !!obj(r, v, m)\n        } else {\n          return (r) => !!obj(r)\n        }\n      } else {\n        return () => !!obj\n      }\n    } else {\n      return () => def\n    }\n  }\n\n  updateBindingValue(path, newValue) {\n    let lastAnyModified = this.anyModified\n    let binding = this._bindings[path]\n\n    if (binding) {\n      if (binding.noValue) {\n        throw new Error(\n          `Attempt to update value for non-value binding '${path}'`\n        )\n      }\n\n      binding.state.value = newValue\n      binding.state.modified = newValue !== binding.unmodifiedValue\n\n      this._updateBindingAttributes()\n\n      if (lastAnyModified !== this.anyModified && this._onAnyModified) {\n        this._onAnyModified(this.anyModified)\n      }\n    }\n\n    return binding.state\n  }\n\n  _updateBindingAttributes() {\n    this.anyModified = false\n    this.allValid = true\n\n    // Do value bindings first\n    for (let path in this._bindings) {\n      let binding = this._bindings[path]\n\n      if (binding.noValue) {\n        continue\n      }\n\n      let valid = binding.isValid(this, binding.state.value)\n\n      // Only value bindings can change these two properties\n      this.allValid = valid && this.allValid\n      this.anyModified = binding.state.modified || this.anyModified\n\n      Object.assign(binding.state, {\n        valid,\n        disabled: binding.isDisabled(this),\n        readOnly: binding.isReadOnly(this),\n        visible: binding.isVisible(this),\n      })\n    }\n\n    // Do non-value bindings second\n    for (let path in this._bindings) {\n      let binding = this._bindings[path]\n\n      if (!binding.noValue) {\n        continue\n      }\n\n      let disabled = binding.isDisabled(this)\n      let readOnly = binding.isReadOnly(this)\n      let visible = binding.isVisible(this)\n\n      // Did the disabled, read-only or visible state of this binding change?\n      let anyChanges =\n        disabled !== binding.state.disabled ||\n        readOnly !== binding.state.readOnly ||\n        visible !== binding.state.visible\n\n      if (anyChanges) {\n        binding.state = {\n          disabled,\n          readOnly,\n          visible,\n        }\n\n        // Fire an event so the non-value component can update itself\n        this.emit(path, { path, state: binding.state })\n      }\n    }\n  }\n\n  getBindingValue(path) {\n    return this.getBindingState(path).value\n  }\n\n  getBindingState(path) {\n    let binding = this._bindings[path]\n\n    if (!binding) {\n      throw new Error(`There is no binding entry for '${path}'`)\n    }\n\n    return binding.state\n  }\n\n  getDeltaObject() {\n    // Generate an object that has the modified and alwaysGet bindings\n    let obj = {}\n\n    if (!this.anyModified && !this.allValid) {\n      return obj\n    }\n\n    // Will have an _id if updating\n    if (this._id) {\n      obj._id = this._id\n    }\n\n    for (let path in this._bindings) {\n      let binding = this._bindings[path]\n\n      if (binding.alwaysGet || (!binding.noValue && binding.state.modified)) {\n        let value = binding.state.value\n\n        if (value && value.constructor === \"String\") {\n          value = value.trim()\n\n          if (value === binding.unmodifiedValue) {\n            continue\n          }\n        }\n\n        value = binding.post ? binding.post(value) : value\n\n        FormBinder._setObjectPathValue(obj, path, value)\n      }\n    }\n\n    return obj\n  }\n\n  static _getObjectPathValue(obj, path) {\n    path.split(\".\").forEach((namePart) => {\n      if (obj) {\n        obj = obj[namePart]\n      }\n    })\n    return obj\n  }\n\n  static _setObjectPathValue(obj, path, value) {\n    path.split(\".\").forEach((namePart, i, nameParts) => {\n      if (i < nameParts.length - 1) {\n        if (!obj[namePart]) {\n          obj[namePart] = {}\n        }\n        obj = obj[namePart]\n      } else {\n        obj[namePart] = value\n      }\n    })\n  }\n}\n"],"file":"FormBinder.js"}