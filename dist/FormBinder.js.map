{"version":3,"sources":["../src/FormBinder.js"],"names":["FormBinder","originalObj","bindings","onAnyModified","_updateFieldValue","bind","_id","fields","noValueFields","name","binding","field","isDisabled","ensureFunc","isReadOnly","isVisible","noValue","state","disabled","readOnly","visible","alwaysGet","isValid","initValue","undefined","originalValue","getObjectFieldValue","_updateOtherFields","obj","def","constructor","Function","r","v","newValue","meta","lastAnyModified","anyModified","value","valid","modified","changedField","allValid","anyChanges","emit","getFieldState","Error","trim","setObjectFieldValue","split","forEach","namePart","i","nameParts","length"],"mappings":"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","file":"FormBinder.js","sourcesContent":["import EventEmitter from 'eventemitter3'\n\nexport class FormBinder extends EventEmitter {\n  constructor(originalObj, bindings, onAnyModified) {\n    super()\n    this._updateFieldValue = this._updateFieldValue.bind(this)\n    this._id = originalObj._id\n    this.onAnyModified = onAnyModified\n    this.fields = {}\n    this.noValueFields = {}\n\n    for (let name in bindings) {\n      let binding = bindings[name]\n      let field = {\n        isDisabled: this.ensureFunc(binding.isDisabled, false),\n        isReadOnly: this.ensureFunc(binding.isReadOnly, false),\n        isVisible: this.ensureFunc(binding.isVisible, true),\n        noValue: !!binding.noValue\n      }\n\n      if (field.noValue) {\n        field.state = {\n          disabled: field.isDisabled(this),\n          readOnly: field.isReadOnly(this),\n          visible: field.isVisible(this),\n        }\n      } else {\n        field.alwaysGet = binding.alwaysGet\n        field.isValid = this.ensureFunc(binding.isValid, true)\n        field.initValue = (binding.initValue === undefined ? '' : binding.initValue)\n        field.originalValue = FormBinder.getObjectFieldValue(originalObj, name)\n        this._updateFieldValue(field, field.originalValue || field.initValue)\n      }\n      this.fields[name] = field\n    }\n\n    this._updateOtherFields()\n  }\n\n  ensureFunc(obj, def) {\n    // If obj is a func and does not return bool there are problems. So we wrap.\n    return obj ? ((obj.constructor === Function) ? (r, v) => (!!obj(r, v)) : () => (!!obj)) : () => (def)\n  }\n\n  updateFieldValue(name, newValue, meta) {\n    let lastAnyModified = this.anyModified\n    let field = this.fields[name]\n\n    if (field) {\n      this._updateFieldValue(field, newValue, meta)\n      this._updateOtherFields(field)\n      if (lastAnyModified !== this.anyModified && this.onAnyModified) {\n        this.onAnyModified(this.anyModified)\n      }\n    }\n\n    return field.state\n  }\n\n  _updateFieldValue(field, newValue) {\n    field.state = {\n      value: newValue,\n      disabled: field.isDisabled(this),\n      readOnly: field.isReadOnly(this),\n      visible: field.isVisible(this),\n      valid: field.isValid(this, newValue),\n      modified: field.originalValue !== undefined ?\n        (field.originalValue !== newValue) : (newValue !== field.initValue)\n    }\n  }\n\n  _updateOtherFields(changedField) {\n    if (changedField) {\n      this.anyModified = changedField.state.modified\n      this.allValid = changedField.state.valid\n    } else {\n      this.anyModified = false\n      this.allValid = true\n    }\n\n    for (let name in this.fields) {\n      let field = this.fields[name]\n\n      if (changedField === field) {\n        continue\n      }\n\n      let valid = undefined\n\n      if (!field.noValue) {\n        valid = field.isValid(this, field.state.value)\n\n        this.allValid = (valid && this.allValid)\n        this.anyModified = (field.state.modified || this.anyModified)\n      }\n\n      let disabled = field.isDisabled(this)\n      let readOnly = field.isReadOnly(this)\n      let visible = field.isVisible(this)\n\n      // Did the valid, disabled, read-only or visible state of this field change?\n      let anyChanges = (\n        valid !== field.state.valid ||\n        disabled !== field.state.disabled ||\n        readOnly !== field.state.readOnly ||\n        visible !== field.state.visible\n      )\n\n      if (anyChanges) {\n        field.state = {\n          valid,\n          disabled,\n          readOnly,\n          visible,\n          modified: field.state.modified,\n          value: field.state.value\n        }\n        // Fire an event so the component can update itself\n        this.emit(name, { name, state: field.state })\n      }\n    }\n  }\n\n  getFieldValue(name) {\n    return this.getFieldState(name).value\n  }\n\n  getFieldState(name) {\n    let field = this.fields[name] || this.noValueFields[name]\n\n    if (!field) {\n      throw new Error(`Field '${name}' does not have a binding entry`)\n    }\n\n    return field.state\n  }\n\n  getModifiedFieldValues() {\n    // Generate an object that has the modified and alwaysGet fields\n    let obj = {}\n\n    if (!this.anyModified && !this.allValid) {\n      return obj\n    }\n\n    // Will have an _id if updating\n    if (this._id) {\n      obj._id = this._id\n    }\n\n    for (let name in this.fields) {\n      let field = this.fields[name]\n\n      if (field.alwaysGet || (!field.noValue && field.state.modified)) {\n        let value = field.state.value\n\n        if (value && value.constructor === 'String') {\n          value = value.trim()\n        }\n        FormBinder.setObjectFieldValue(obj, name, value)\n      }\n    }\n\n    return obj\n  }\n\n  getOriginalFieldValues() {\n    // Generate an object that has the original values of all fields\n    let obj = {}\n\n    if (this._id) {\n      obj._id = this._id\n    }\n\n    for (let name in this.fields) {\n      let field = this.fields[name]\n\n      if (field.originalValue !== undefined) {\n        FormBinder.setObjectFieldValue(obj, name, field.originalValue)\n      }\n    }\n\n    return obj\n  }\n\n  static getObjectFieldValue(obj, name) {\n    name.split('.').forEach((namePart) => {\n      if (obj) {\n        obj = obj[namePart]\n      }\n    })\n    return obj\n  }\n\n  static setObjectFieldValue(obj, name, value) {\n    name.split('.').forEach((namePart, i, nameParts) => {\n      if (i < nameParts.length - 1) {\n        if (!obj[namePart]) {\n          obj[namePart] = {}\n        }\n        obj = obj[namePart]\n      } else {\n        obj[namePart] = value\n      }\n    })\n  }\n}\n"]}